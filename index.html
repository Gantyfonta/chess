<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Multiplayer Chess with Chat & Moves</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: transparent;
    }
    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
      position: relative;
      z-index: 1; /* UI overlays on effect */
    }
    #chatContainer {
      width: 20%;
      min-width: 200px;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      background: rgba(255,255,255,0.8);
    }
    #chatBox {
      flex: 1;
      overflow-y: auto;
      padding: 5px;
      background: #f8f8f8;
    }
    #chatInput {
      border: none;
      padding: 8px;
      width: calc(100% - 60px);
    }
    #sendBtn {
      padding: 8px;
    }
    #gameArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.8);
    }
    #controls {
      margin: 10px;
    }
    #board {
      width: 400px;
      margin: 20px;
      display: none;
    }
    #movesContainer {
      width: 20%;
      min-width: 200px;
      border-left: 1px solid #ccc;
      background: rgba(255,255,255,0.8);
      overflow-y: auto;
      padding: 10px;
    }
    #movesBox {
      font-family: monospace;
    }
    #winner {
      font-weight: bold;
      margin-top: 10px;
    }
    /* LiquidEther canvas behind */
    #liquidBg {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
    }
  </style>
</head>
<body>
  <!-- Background -->
  <div id="liquidBg"></div>

  <!-- Foreground app -->
  <div id="app">
    <!-- Chat left -->
    <div id="chatContainer">
      <div id="chatBox"></div>
      <div style="display:flex;">
        <input id="chatInput" type="text" placeholder="Type a message...">
        <button id="sendBtn">Send</button>
      </div>
    </div>

    <!-- Chess middle -->
    <div id="gameArea">
      <h1>Multiplayer Chess</h1>
      <div id="controls">
        <input type="text" id="roomCode" placeholder="Enter room code">
        <button id="joinBtn">Join Room</button>
      </div>
      <div id="board"></div>
      <div id="winner"></div>
    </div>

    <!-- Moves right -->
    <div id="movesContainer">
      <h3>Moves</h3>
      <div id="movesBox"></div>
    </div>
  </div>

  <!-- Chessboard + Chess.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, update, get, onValue, push, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Replace with your Firebase project config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let board, game = new Chess();
    let myColor = null;
    let myId = null;
    let roomRef = null;
    let roomCode = null;

    // --- Room join ---
    document.getElementById("joinBtn").onclick = async () => {
      const code = document.getElementById("roomCode").value;
      if (!code) return alert("Enter a room code!");
      roomCode = code;
      roomRef = ref(db, "rooms/" + roomCode);
      const snapshot = await get(roomRef);

      if (!snapshot.exists()) {
        myColor = "w";
        myId = Date.now();
        await set(roomRef, {
          fen: game.fen(),
          players: { [myId]: myColor },
          turn: "w",
          moves: []
        });
      } else {
        myColor = "b";
        myId = Date.now();
        await update(roomRef, {
          [`players/${myId}`]: myColor
        });
      }

      initBoard();
      listenForUpdates();
      listenForChat();
    };

    // --- Chessboard init ---
    function initBoard() {
      board = Chessboard("board", {
        draggable: true,
        position: game.fen(),
        onDrop: handleMove
      });
      document.getElementById("board").style.display = "block";
    }

    // --- Handle moves ---
    function handleMove(source, target) {
      if (game.turn() !== myColor) return "snapback";

      const move = game.move({ from: source, to: target, promotion: "q" });
      if (!move) return "snapback";

      update(roomRef, {
        fen: game.fen(),
        turn: game.turn()
      });

      // Store move in Firebase moves list
      const moveText = `${move.san}`;
      const movesRef = ref(db, `rooms/${roomCode}/moves`);
      push(movesRef, moveText);
    }

    // --- Firebase board updates ---
    function listenForUpdates() {
      onValue(roomRef, (snap) => {
        if (!snap.exists()) return;
        const data = snap.val();
        if (data.fen && data.fen !== game.fen()) {
          game.load(data.fen);
          board.position(game.fen());
        }

        if (game.game_over()) {
          let result = "Draw";
          if (game.in_checkmate()) {
            result = (game.turn() === "w" ? "Black" : "White") + " wins!";
          }
          document.getElementById("winner").textContent = result;
        }
      });

      // Listen for moves
      const movesRef = ref(db, `rooms/${roomCode}/moves`);
      onChildAdded(movesRef, (snap) => {
        const move = snap.val();
        const movesBox = document.getElementById("movesBox");
        const div = document.createElement("div");
        div.textContent = move;
        movesBox.appendChild(div);
        movesBox.scrollTop = movesBox.scrollHeight;
      });
    }

    // --- Chat ---
    function listenForChat() {
      const chatRef = ref(db, `rooms/${roomCode}/chat`);
      onChildAdded(chatRef, (snap) => {
        const msg = snap.val();
        const chatBox = document.getElementById("chatBox");
        const div = document.createElement("div");
        div.textContent = `${msg.sender}: ${msg.text}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    function sendChatMessage(text) {
      const chatRef = ref(db, `rooms/${roomCode}/chat`);
      push(chatRef, {
        sender: myColor === "w" ? "White" : "Black",
        text,
        time: Date.now()
      });
    }

    document.getElementById("sendBtn").onclick = () => {
      const input = document.getElementById("chatInput");
      if (input.value.trim()) {
        sendChatMessage(input.value.trim());
        input.value = "";
      }
    };

    document.getElementById("chatInput").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        document.getElementById("sendBtn").click();
      }
    });
  </script>

  <!-- LiquidEther background -->
  <script type="module">
    import LiquidEther from './LiquidEther.js';
    const container = document.getElementById("liquidBg");
    new LiquidEther(container, {
      colors:[ '#5227FF', '#FF9FFC', '#B19EEF' ],
      mouseForce:20,
      cursorSize:100,
      isViscous:false,
      viscous:30,
      iterationsViscous:32,
      iterationsPoisson:32,
      resolution:0.5,
      isBounce:false,
      autoDemo:true,
      autoSpeed:0.5,
      autoIntensity:2.2,
      takeoverDuration:0.25,
      autoResumeDelay:3000,
      autoRampDuration:0.6
    });
  </script>
</body>
</html>
