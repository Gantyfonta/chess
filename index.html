<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Portal Chess</title>
  <link rel="stylesheet" href="https://unpkg.com/chessboardjs@1.0.0/www/css/chessboard-1.0.0.min.css">
  <style>
    body { font-family: sans-serif; background: #222; color: white; text-align: center; }
    #board { width: 400px; margin: 20px auto; }
    .portal { pointer-events: none; position: absolute; }
  </style>
</head>
<body>
  <h1>Portal Chess</h1>
  <div>
    <input id="roomCode" placeholder="Room Code">
    <select id="variantSelect">
      <option value="regular">Regular Chess</option>
      <option value="portal">Portal Chess</option>
    </select>
    <button id="joinBtn">Join Room</button>
  </div>
  <div id="board"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
  <script src="https://unpkg.com/chessboardjs@1.0.0/www/js/chessboard-1.0.0.min.js"></script>

  <script>
    // ðŸ”¥ Your Firebase config here
    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "123",
      appId: "123"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const game = new Chess();
    let board, myColor, roomCode, variant = "regular";
    let myId = Math.random().toString(36).substring(2,9);
    let portals = {}, portalPlaced = false;

    function initBoard() {
      board = Chessboard('board', {
        draggable: true,
        position: 'start',
        orientation: myColor,
        onDrop: onDrop
      });
    }

    async function joinRoom(code) {
      roomCode = code;
      const roomRef = db.ref("rooms/" + code);

      // add self to players list
      await roomRef.child("players").child(myId).set({ color: null });

      // assign colors automatically
      roomRef.child("players").once("value", snap => {
        const players = snap.val() || {};
        const ids = Object.keys(players);
        if (ids.length === 1) {
          myColor = "white";
          roomRef.child("players/" + myId + "/color").set("white");
        } else if (ids.length === 2) {
          if (!Object.values(players).some(p => p.color === "white")) {
            myColor = "white";
            roomRef.child("players/" + myId + "/color").set("white");
          } else {
            myColor = "black";
            roomRef.child("players/" + myId + "/color").set("black");
          }
        }
        initBoard();
        enablePortalPlacement();
      });

      // store player variant choice
      const myChoice = document.getElementById("variantSelect").value;
      db.ref("rooms/" + code + "/playersVariant/" + myId).set(myChoice);

      // decide final variant
      db.ref("rooms/" + code + "/playersVariant").on("value", snap => {
        const variants = snap.val() || {};
        const vals = Object.values(variants);
        if (vals.length === 2 && new Set(vals).size === 1 && vals[0] === "portal") {
          variant = "portal";
        } else {
          variant = "regular";
        }
        console.log("Variant is", variant);
      });

      // listen to game state
      roomRef.child("state").on("value", snap => {
        const s = snap.val();
        if (s) {
          game.load(s.fen);
          board.position(s.fen, false);
        }
      });

      // listen to portals
      db.ref("rooms/" + code + "/portals").on("value", snap => {
        portals = snap.val() || {};
        drawPortals();
      });

      // init state if none
      roomRef.child("state").once("value", snap => {
        if (!snap.exists()) {
          roomRef.child("state").set({ fen: game.fen(), turn: game.turn(), variant: "regular" });
        }
      });
    }

    function onDrop(source, target) {
      const move = game.move({ from: source, to: target, promotion: "q" });
      if (move === null) return "snapback";

      // portal teleport
      if (variant === "portal") handlePortalMove(move);

      db.ref("rooms/" + roomCode + "/state").set({
        fen: game.fen(),
        turn: game.turn(),
        variant
      });
    }

    function enablePortalPlacement() {
      if (variant !== "portal" || portalPlaced) return;
      document.querySelector("#board").addEventListener("click", e => {
        if (portalPlaced || variant !== "portal") return;
        const squareEl = e.target.closest(".square-55d63");
        if (!squareEl) return;
        const square = squareEl.classList[1].split("-")[1];
        const rank = square[1];
        if ((myColor === "white" && rank === "1") || (myColor === "black" && rank === "8")) return;

        db.ref("rooms/" + roomCode + "/portals/" + myColor).set(square);
        portalPlaced = true;
      });
    }

    function drawPortals() {
      document.querySelectorAll(".portal").forEach(el => el.remove());
      for (const [color, square] of Object.entries(portals)) {
        const el = document.querySelector(`.square-${square}`);
        if (el) {
          const img = document.createElement("img");
          img.src = "pieces/portal.png";
          img.className = "portal";
          img.style.width = "80%";
          el.appendChild(img);
        }
      }
    }

    function handlePortalMove(move) {
      const myPortal = portals[move.color];
      const oppPortal = portals[move.color === "w" ? "black" : "white"];
      if (!myPortal || !oppPortal) return;

      if (move.to === oppPortal) {
        const pieceAtTarget = game.get(myPortal);
        if (pieceAtTarget && pieceAtTarget.color === move.color) {
          // teleport blocked
          return;
        }
        if (pieceAtTarget && pieceAtTarget.color !== move.color) {
          game.remove(myPortal);
        }
        game.remove(move.to);
        game.put({ type: move.piece, color: move.color }, myPortal);
      }
    }

    document.getElementById("joinBtn").addEventListener("click", () => {
      joinRoom(document.getElementById("roomCode").value);
    });
  </script>
</body>
</html>
